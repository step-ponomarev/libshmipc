name: "Platform Matrix (Reusable)"

on:
  workflow_call:
    inputs:
      arm_runner_label:
        required: false
        type: string
        description: "Label for Linux arm64 runner (e.g. ubuntu-24.04-arm64 or partner label)"
        default: "ubuntu-24.04-arm64"
      enable_arm64:
        required: false
        type: boolean
        description: "Include linux arm64 in matrices"
        default: true
    outputs:
      core_matrix:
        description: "Matrix (runner/os/arch) for core builds/tests"
        value: ${{ jobs.define.outputs.core_matrix }}
      java_matrix:
        description: "Matrix (runner/os/arch/platform/ext) for Java SDK builds/tests"
        value: ${{ jobs.define.outputs.java_matrix }}

jobs:
  define:
    runs-on: ubuntu-latest
    outputs:
      core_matrix: ${{ steps.set.outputs.core_matrix }}
      java_matrix: ${{ steps.set.outputs.java_matrix }}
    env:
      ARM_RUNNER_LABEL: ${{ inputs.arm_runner_label }}
      ENABLE_ARM64: ${{ inputs.enable_arm64 }}
    steps:
      - id: set
        run: |
          arm_runner="${ARM_RUNNER_LABEL}"
          enable_raw="${ENABLE_ARM64}"
          if [ "${enable_raw}" = "true" ] || [ "${enable_raw}" = "True" ]; then
            arm_enabled=true
          else
            arm_enabled=false
          fi
          echo "Using ARM runner label: ${arm_runner}; enable_arm64=${arm_enabled}"

          core_json=$(jq -nc \
            --arg runner "$arm_runner" \
            --argjson arm_enabled "$arm_enabled" \
            '{
              include: [
                {os_name:"linux", arch:"x86_64", runner:"ubuntu-latest"},
                {os_name:"macos", arch:"arm64", runner:"macos-latest"},
                {os_name:"macos", arch:"x86_64", runner:"macos-13"}
              ]
            } | if $arm_enabled then .include += [{os_name:"linux", arch:"arm64", runner:$runner}] else . end')

          java_json=$(jq -nc \
            --arg runner "$arm_runner" \
            --argjson arm_enabled "$arm_enabled" \
            '{
              include: [
                {os_name:"linux", arch:"x86_64", runner:"ubuntu-latest", platform:"Linux-x86_64", ext:"so"},
                {os_name:"macos", arch:"arm64", runner:"macos-latest", platform:"Darwin-arm64", ext:"dylib"},
                {os_name:"macos", arch:"x86_64", runner:"macos-13", platform:"Darwin-x86_64", ext:"dylib"}
              ]
            } | if $arm_enabled then .include += [{os_name:"linux", arch:"arm64", runner:$runner, platform:"Linux-aarch64", ext:"so"}] else . end')

          printf 'core_matrix=%s\n' "${core_json}" >> "$GITHUB_OUTPUT"
          printf 'java_matrix=%s\n' "${java_json}" >> "$GITHUB_OUTPUT"
