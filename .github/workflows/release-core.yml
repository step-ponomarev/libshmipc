name: "Release Core (Reusable)"

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: "Library version"
      matrix_json:
        required: false
        type: string
        description: "Matrix JSON (include list with os_name/arch/runner)"
        default: |
          {"include":[{"os_name":"linux","arch":"x86_64","runner":"ubuntu-latest"},{"os_name":"macos","arch":"arm64","runner":"macos-latest"},{"os_name":"macos","arch":"x86_64","runner":"macos-13"}]}

jobs:
  build:
    name: Build Core (${{ matrix.os_name }} ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    env:
      BAZEL_BUILD_FLAGS: -c opt
      BAZEL_TEST_FLAGS: --test_output=errors --jobs=1 --cache_test_results=no
      VERSION: ${{ inputs.version }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(inputs.matrix_json) }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Sync MODULE.bazel version to tag
        run: |
          set -euo pipefail
          ver="${VERSION}"
          python3 - "$ver" <<'PY'
  import pathlib, re, sys
  ver = sys.argv[1]
  path = pathlib.Path("MODULE.bazel")
  text = path.read_text()
  pattern = re.compile(r'(version\s*=\s*")(.*?)(")')
  m = pattern.search(text)
  if m:
      new = text[:m.start(2)] + ver + text[m.end(2):]
  else:
      new = re.sub(r'(module\(\s*[^)]*)', r'\1\n    version = "' + ver + '",', text, count=1)
  path.write_text(new)
  print(f"Set MODULE.bazel version to {ver}")
PY

      - uses: bazel-contrib/setup-bazel@0.15.0
        with:
          bazelrc: common --enable_bzlmod
          bazelisk-cache: true
          repository-cache: true
          disk-cache: ${{ github.workflow }}

      - name: Build (opt)
        run: bazel build $BAZEL_BUILD_FLAGS //:shmipc //:shmipc_shared

      - name: Test (no cache, single-threaded)
        run: bazel test $BAZEL_TEST_FLAGS //core/tests:all

      - name: Package
        shell: bash
        run: |
          set -euo pipefail
          ver="${{ env.VERSION }}"
          os="${{ matrix.os_name }}"
          arch="${{ matrix.arch }}"
          pkg="libshmipc-${ver}-${os}-${arch}"

          BIN_DIR="$(bazel info $BAZEL_BUILD_FLAGS bazel-bin)"

          mkdir -p "dist/${pkg}/include" "dist/${pkg}/lib"
          cp -R include/shmipc "dist/${pkg}/include/"
          cp "${BIN_DIR}/core/libshmipc.a" "dist/${pkg}/lib/"

          if [[ "${os}" == "macos" ]]; then
            cp "${BIN_DIR}/core/libshmipc_shared.dylib" "dist/${pkg}/lib/libshmipc.dylib"
          else
            if [[ -f "${BIN_DIR}/core/libshmipc_shared.so" ]]; then
              cp "${BIN_DIR}/core/libshmipc_shared.so" "dist/${pkg}/lib/libshmipc.so"
            else
              find "${BIN_DIR}/core" -maxdepth 1 -name 'libshmipc_shared*.so*' -exec cp {} "dist/${pkg}/lib/" \; || true
            fi
          fi

          (cd dist && tar -czf "${pkg}.tar.gz" "${pkg}")
          (cd dist && shasum -a 256 "${pkg}.tar.gz" > "${pkg}.tar.gz.sha256")
          rm -rf "dist/${pkg}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shmipc-${{ env.VERSION }}-${{ matrix.os_name }}-${{ matrix.arch }}
          path: |
            dist/*.tar.gz
            dist/*.sha256
