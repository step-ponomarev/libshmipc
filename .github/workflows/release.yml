name: "Release builds"

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"

jobs:
  platform-matrix:
    name: Define platform matrix
    uses: ./.github/workflows/platform-matrix.yml
    with:
      arm_runner_label: ${{ vars.ARM_RUNNER_LABEL || 'ubuntu-24.04-arm64' }}
      enable_arm64: false

  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Extract version from tag
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          ref="${GITHUB_REF_NAME:-}"
          [[ "$ref" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]] || { echo "Tag name must look like v0.0.0, got: ${ref}" >&2; exit 1; }
          ver="${ref#v}"
          echo "version=$ver" >> "$GITHUB_OUTPUT"

  bump-version-main:
    name: Sync version on main
    runs-on: ubuntu-latest
    needs: get-version
    env:
      VERSION: ${{ needs.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Update MODULE.bazel version
        run: |
          set -euo pipefail
          ver="${VERSION}"
          python - "$ver" <<'PY'
          import pathlib, re, sys
          ver = sys.argv[1]
          path = pathlib.Path("MODULE.bazel")
          text = path.read_text()
          pattern = r'(version\s*=\s*")[^"]*(")'
          if re.search(pattern, text):
              m = re.search(pattern, text)
              new = text[:m.start(1)+len(m.group(1))] + ver + text[m.end(2)-1:]
          else:
              new = re.sub(r'(module\(\s*[^)]*)', r'\1\n    version = "' + ver + '",', text, count=1)
          path.write_text(new)
          print(f"Set MODULE.bazel version to {ver}")
          PY

      - name: Commit and push if changed
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          set -euo pipefail
          if git diff --quiet MODULE.bazel; then
            echo "MODULE.bazel already at ${VERSION}, nothing to commit."
            exit 0
          fi
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add MODULE.bazel
          git commit -m "chore: bump version to v${VERSION}"
          git push origin HEAD:main
  release-core:
    uses: ./.github/workflows/release-core.yml
    needs: [platform-matrix, get-version]
    with:
      version: ${{ needs.get-version.outputs.version }}
      matrix_json: ${{ needs.platform-matrix.outputs.core_matrix }}

  release-java-sdk:
    uses: ./.github/workflows/release-java-sdk.yml
    needs: [platform-matrix, get-version]
    with:
      version: ${{ needs.get-version.outputs.version }}
      matrix_json: ${{ needs.platform-matrix.outputs.java_matrix }}

  package-java:
    name: Package Java JAR
    needs: [get-version, release-java-sdk]
    runs-on: ubuntu-latest
    env:
      BAZEL_BUILD_FLAGS: -c opt
      VERSION: ${{ needs.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Sync MODULE.bazel version to tag
        run: |
          set -euo pipefail
          ver="${VERSION}"
          python3 - "$ver" <<'PY'
            import pathlib, re, sys
            ver = sys.argv[1]
            path = pathlib.Path("MODULE.bazel")
            text = path.read_text()
            pattern = re.compile(r'(version\s*=\s*")(.*?)(")')
            m = pattern.search(text)
            if m:
                new = text[:m.start(2)] + ver + text[m.end(2):]
            else:
                new = re.sub(r'(module\(\s*[^)]*)', r'\1\n    version = "' + ver + '",', text, count=1)
            path.write_text(new)
            print(f"Set MODULE.bazel version to {ver}")
          PY

      - uses: bazel-contrib/setup-bazel@0.15.0
        with:
          bazelrc: common --enable_bzlmod
          bazelisk-cache: true
          repository-cache: true
          disk-cache: ${{ github.workflow }}

      - name: Download all JNI libraries
        uses: actions/download-artifact@v4
        with:
          path: jni_libs_all

      - name: Build Java core library
        run: bazel build $BAZEL_BUILD_FLAGS //java:shmipc_java_core

      - name: Create multi-platform JAR
        shell: bash
        run: |
          set -euo pipefail
          ver="${{ env.VERSION }}"
          BIN_DIR="$(bazel info $BAZEL_BUILD_FLAGS bazel-bin)"

          BASE_JAR="${BIN_DIR}/java/libshmipc_java_core.jar"
          FINAL_JAR="dist/libshmipc-java-${ver}.jar"
          
          mkdir -p dist jar_temp
          cd jar_temp
          
          jar xf "../${BASE_JAR}"

          mkdir -p native
          find ../jni_libs_all -name "libshmipc_jni.*" -type f || true
          
          # Each platform has its own artifact: jni_libs_all/jni-${PLATFORM}/jni_libs/native/${PLATFORM}/libshmipc_jni.{ext}
          for jni_artifact_dir in ../jni_libs_all/jni-*/; do
            if [ -d "$jni_artifact_dir" ]; then
              platform=$(basename "$jni_artifact_dir" | sed 's/^jni-//')
              native_lib_path="${jni_artifact_dir}jni_libs/native/${platform}/libshmipc_jni."*
              
              if ls ${native_lib_path} 1> /dev/null 2>&1; then
                echo "Copying native libs for platform: $platform"
                mkdir -p "native/${platform}"
                cp ${native_lib_path} "native/${platform}/"
              else
                echo "WARNING: Native library not found for platform $platform at ${native_lib_path}" >&2
              fi
            fi
          done
          
          echo "Native libraries structure:"
          find native -type f || true
          
          expected_platforms=("Linux-x86_64" "Linux-aarch64" "Darwin-arm64" "Darwin-x86_64")
          for platform in "${expected_platforms[@]}"; do
            if [ ! -f "native/${platform}/libshmipc_jni."* ]; then
              echo "ERROR: Missing native library for platform: $platform" >&2
              exit 1
            fi
          done
          
          jar cf "../${FINAL_JAR}" *
          cd ..
          
          echo "JAR contents (showing native libraries and sample classes):"
          jar tf "${FINAL_JAR}" | grep -E "native/" || true
          jar tf "${FINAL_JAR}" | grep "\.class" | head -5 || true
          
          echo "Verifying all platforms in JAR (matching LibLoader.java expectations):"
          declare -A platform_checks=(
            ["Linux-x86_64"]="native/Linux-x86_64/libshmipc_jni.so"
            ["Linux-aarch64"]="native/Linux-aarch64/libshmipc_jni.so"
            ["Darwin-arm64"]="native/Darwin-arm64/libshmipc_jni.dylib"
            ["Darwin-x86_64"]="native/Darwin-x86_64/libshmipc_jni.dylib"
          )
          
          for platform in "${expected_platforms[@]}"; do
            expected_path="${platform_checks[$platform]}"
            if jar tf "${FINAL_JAR}" | grep -q "^${expected_path}$"; then
              echo "✓ Platform $platform: $expected_path (matches LibLoader.java expectation: /${expected_path})"
            else
              echo "✗ ERROR: Platform $platform NOT found at expected path: $expected_path" >&2
              echo "  Found paths:" >&2
              jar tf "${FINAL_JAR}" | grep "native/${platform}/" >&2 || echo "  (none)" >&2
              exit 1
            fi
          done
          
          shasum -a 256 "${FINAL_JAR}" > "${FINAL_JAR}.sha256"
          echo "Created: ${FINAL_JAR} and ${FINAL_JAR}.sha256"

      - name: Upload Java JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: java-jar-${{ env.VERSION }}
          path: |
            dist/*.jar
            dist/*.sha256

  release:
    name: Release
    needs: [get-version, release-core, package-java, bump-version-main]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist_artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.get-version.outputs.version }}
          name: shmipc ${{ needs.get-version.outputs.version }}
          prerelease: true
          files: |
            dist_artifacts/**/*.tar.gz
            dist_artifacts/**/*.sha256
            dist_artifacts/**/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
