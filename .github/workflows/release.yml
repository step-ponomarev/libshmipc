name: "Release builds"

permissions:
  contents: write

on:
  push:
    branches: [ main ]

jobs:
  build-matrix:
    name: Build (${{ matrix.os_name }} ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    env:
      BAZEL_BUILD_FLAGS: -c opt
      BAZEL_TEST_FLAGS: --test_output=errors --jobs=1 --cache_test_results=no
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_name: linux
            arch: x86_64
            runner: ubuntu-latest
          - os_name: linux
            arch: arm64
            runner: ubuntu-24.04-arm64
          - os_name: macos
            arch: arm64
            runner: macos-latest
          - os_name: macos
            arch: x86_64
            runner: macos-13

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true

      - uses: bazel-contrib/setup-bazel@0.15.0
        with:
          bazelrc: common --enable_bzlmod
          bazelisk-cache: true
          repository-cache: true
          disk-cache: ${{ github.workflow }}

      - name: Build (opt)
        run: bazel build $BAZEL_BUILD_FLAGS //:shmipc //:shmipc_shared

      - name: Test (no cache, single-threaded)
        run: bazel test $BAZEL_TEST_FLAGS //tests:all

      - name: Extract version from MODULE.bazel
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          ver=$(awk -F '"' '/version[[:space:]]*=/{print $2; exit}' MODULE.bazel)
          [[ -n "$ver" ]] || { echo "Failed to extract version from MODULE.bazel" >&2; exit 1; }
          echo "ver=$ver" >> "$GITHUB_OUTPUT"

      - name: Package
        shell: bash
        run: |
          set -euo pipefail
          ver="${{ steps.ver.outputs.ver }}"
          os="${{ matrix.os_name }}"
          arch="${{ matrix.arch }}"
          pkg="libshmipc-${ver}-${os}-${arch}"

          BIN_DIR="$(bazel info $BAZEL_BUILD_FLAGS bazel-bin)"

          mkdir -p "dist/${pkg}/include" "dist/${pkg}/lib"
          cp -R include/shmipc "dist/${pkg}/include/"
          cp "${BIN_DIR}/libshmipc.a" "dist/${pkg}/lib/"

          if [[ "${os}" == "macos" ]]; then
            cp "${BIN_DIR}/libshmipc_shared.dylib" "dist/${pkg}/lib/libshmipc.dylib"
          else
            if [[ -f "${BIN_DIR}/libshmipc_shared.so" ]]; then
              cp "${BIN_DIR}/libshmipc_shared.so" "dist/${pkg}/lib/libshmipc.so"
            else
              find "${BIN_DIR}" -maxdepth 1 -name 'libshmipc_shared*.so*' -exec cp {} "dist/${pkg}/lib/" \; || true
            fi
          fi

          (cd dist && tar -czf "${pkg}.tar.gz" "${pkg}")
          (cd dist && shasum -a 256 "${pkg}.tar.gz" > "${pkg}.tar.gz.sha256")
          rm -rf "dist/${pkg}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shmipc-${{ steps.ver.outputs.ver }}-${{ matrix.os_name }}-${{ matrix.arch }}
          path: |
            dist/*.tar.gz
            dist/*.sha256

  release:
    name: Release
    needs: build-matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist_artifacts

      - name: Extract version from MODULE.bazel
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          ver=$(awk -F '"' '/version[[:space:]]*=/{print $2; exit}' MODULE.bazel)
          [[ -n "$ver" ]] || { echo "Failed to extract version from MODULE.bazel" >&2; exit 1; }
          echo "ver=$ver" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.ver.outputs.ver }}
          name: shmipc ${{ steps.ver.outputs.ver }}
          prerelease: true
          files: |
            dist_artifacts/**/*.tar.gz
            dist_artifacts/**/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
