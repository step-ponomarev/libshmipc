=== Building with ThreadSanitizer ===
-- The C compiler identification is AppleClang 17.0.0.17000013
-- The CXX compiler identification is AppleClang 17.0.0.17000013
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Check for working C compiler: /usr/bin/cc - skipped
-- Detecting C compile features
-- Detecting C compile features - done
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Check for working CXX compiler: /usr/bin/c++ - skipped
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Enabling ThreadSanitizer for shmipc_static
-- Enabling ThreadSanitizer for shmipc_shared
-- Performing Test CMAKE_HAVE_LIBC_PTHREAD
-- Performing Test CMAKE_HAVE_LIBC_PTHREAD - Success
-- Found Threads: TRUE
-- Enabling ThreadSanitizer for ipc_buffer_basic_test
-- Enabling ThreadSanitizer for ipc_channel_basic_test
-- Enabling ThreadSanitizer for ipc_mmap_test
-- Enabling ThreadSanitizer for ipc_buffer_concurrency_test
-- Enabling ThreadSanitizer for ipc_channel_concurrent_test
-- Enabling ThreadSanitizer for ipc_channel_interprocess_test
-- Enabling ThreadSanitizer for ipc_buffer_stress_test
-- Enabling ThreadSanitizer for ipc_channel_interprocess_stress_test
-- Enabling ThreadSanitizer for ipc_channel_stress_test
-- Configuring done (5.0s)
-- Generating done (0.1s)
-- Build files have been written to: /Users/stepan/libshmipc/build_tsan
[  3%] Building C object src/CMakeFiles/shmipc_static.dir/ipc_buffer.c.o
[  7%] Building C object src/CMakeFiles/shmipc_shared.dir/ipc_buffer.c.o
[ 17%] Building C object src/CMakeFiles/shmipc_shared.dir/ipc_utils.c.o
[ 17%] Building C object src/CMakeFiles/shmipc_shared.dir/ipc_mmap.c.o
[ 17%] Building C object src/CMakeFiles/shmipc_static.dir/ipc_channel.c.o
[ 21%] Building C object src/CMakeFiles/shmipc_shared.dir/ipc_channel.c.o
[ 25%] Building C object src/CMakeFiles/shmipc_static.dir/ipc_mmap.c.o
[ 28%] Building C object src/CMakeFiles/shmipc_static.dir/ipc_utils.c.o
[ 32%] Linking C static library libshmipc_static.a
[ 35%] Linking C shared library libshmipc_shared.dylib
[ 35%] Built target shmipc_static
[ 35%] Built target shmipc_shared
[ 42%] Building CXX object tests/CMakeFiles/ipc_buffer_basic_test.dir/ipc_buffer_basic_test.cpp.o
[ 46%] Building CXX object tests/CMakeFiles/ipc_channel_concurrent_test.dir/ipc_channel_concurrency_test.cpp.o
[ 50%] Building CXX object tests/CMakeFiles/ipc_channel_basic_test.dir/ipc_channel_basic_test.cpp.o
[ 42%] Building CXX object tests/CMakeFiles/ipc_buffer_stress_test.dir/ipc_buffer_stress_test.cpp.o
[ 53%] Building CXX object tests/CMakeFiles/ipc_mmap_test.dir/ipc_mmap_test.cpp.o
[ 57%] Building CXX object tests/CMakeFiles/ipc_buffer_concurrency_test.dir/ipc_buffer_concurrency_test.cpp.o
[ 60%] Building CXX object tests/CMakeFiles/ipc_channel_stress_test.dir/ipc_channel_stress_test.cpp.o
[ 64%] Building CXX object tests/CMakeFiles/ipc_channel_interprocess_stress_test.dir/ipc_channel_interprocess_stress_test.cpp.o
[ 67%] Building CXX object tests/CMakeFiles/ipc_channel_interprocess_test.dir/ipc_channel_interprocess_test.cpp.o
[ 71%] Linking CXX executable ipc_mmap_test
[ 71%] Built target ipc_mmap_test
[ 75%] Linking CXX executable ipc_channel_basic_test
[ 78%] Linking CXX executable ipc_channel_interprocess_test
[ 82%] Linking CXX executable ipc_buffer_stress_test
[ 85%] Linking CXX executable ipc_channel_interprocess_stress_test
[ 89%] Linking CXX executable ipc_channel_stress_test
[ 92%] Linking CXX executable ipc_buffer_basic_test
[ 92%] Built target ipc_channel_basic_test
[ 92%] Built target ipc_channel_interprocess_test
[ 92%] Built target ipc_buffer_stress_test
[ 92%] Built target ipc_channel_interprocess_stress_test
[ 92%] Built target ipc_buffer_basic_test
[ 92%] Built target ipc_channel_stress_test
[ 96%] Linking CXX executable ipc_channel_concurrent_test
[ 96%] Built target ipc_channel_concurrent_test
[100%] Linking CXX executable ipc_buffer_concurrency_test
[100%] Built target ipc_buffer_concurrency_test

=== Running tests with ThreadSanitizer ===
Test project /Users/stepan/libshmipc/build_tsan
    Start 1: ipc_buffer_basic_test
1/9 Test #1: ipc_buffer_basic_test ..................   Passed    0.59 sec
    Start 2: ipc_channel_basic_test
2/9 Test #2: ipc_channel_basic_test .................   Passed    0.71 sec
    Start 3: ipc_mmap_test
3/9 Test #3: ipc_mmap_test ..........................   Passed    0.36 sec
    Start 4: ipc_buffer_concurrency_test
4/9 Test #4: ipc_buffer_concurrency_test ............   Passed    5.61 sec
    Start 5: ipc_channel_concurrent_test
5/9 Test #5: ipc_channel_concurrent_test ............Subprocess aborted***Exception:  23.25 sec
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f40 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:173 (ipc_channel_concurrent_test:arm64+0x10009a36c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x100068550)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x100068490)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x1000683f4)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000683a0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100066660)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f40 by thread T11:
    #0 ipc_buffer_peek ipc_buffer.c:296 (ipc_channel_concurrent_test:arm64+0x10009aa00)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T7 (tid=15934304, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15934308, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:173 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f80 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:167 (ipc_channel_concurrent_test:arm64+0x10009a13c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x100068550)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x100068490)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x1000683f4)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000683a0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100066660)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f80 by thread T11:
    #0 ipc_buffer_peek ipc_buffer.c:296 (ipc_channel_concurrent_test:arm64+0x10009aa00)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T7 (tid=15934304, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15934308, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:167 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f20 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:173 (ipc_channel_concurrent_test:arm64+0x10009a36c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006ee90)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006edd0)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006ed34)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006ece0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x10006cfa0)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f20 by thread T11:
    #0 ipc_buffer_peek ipc_buffer.c:296 (ipc_channel_concurrent_test:arm64+0x10009aa00)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T9 (tid=15934306, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15934308, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:173 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f88 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:168 (ipc_channel_concurrent_test:arm64+0x10009a148)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x100068550)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x100068490)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x1000683f4)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000683a0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100066660)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f88 by thread T11:
    #0 ipc_buffer_peek ipc_buffer.c:302 (ipc_channel_concurrent_test:arm64+0x10009aae0)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T7 (tid=15934304, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15934308, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:168 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103ec0 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:173 (ipc_channel_concurrent_test:arm64+0x10009a36c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103ec0 by thread T11:
    #0 ipc_buffer_peek ipc_buffer.c:296 (ipc_channel_concurrent_test:arm64+0x10009aa00)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15934305, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15934308, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:173 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f88 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:168 (ipc_channel_concurrent_test:arm64+0x10009a148)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f88 by thread T12:
    #0 ipc_buffer_peek ipc_buffer.c:302 (ipc_channel_concurrent_test:arm64+0x10009aae0)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15934305, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T12 (tid=15934309, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:168 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f80 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:167 (ipc_channel_concurrent_test:arm64+0x10009a13c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006ee90)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006edd0)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006ed34)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006ece0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x10006cfa0)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f80 by thread T11:
    #0 ipc_buffer_peek ipc_buffer.c:296 (ipc_channel_concurrent_test:arm64+0x10009aa00)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T9 (tid=15934306, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15934308, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:167 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f80 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:167 (ipc_channel_concurrent_test:arm64+0x10009a13c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f80 by thread T11:
    #0 ipc_buffer_peek ipc_buffer.c:296 (ipc_channel_concurrent_test:arm64+0x10009aa00)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15934305, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15934308, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:167 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f80 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:167 (ipc_channel_concurrent_test:arm64+0x10009a13c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f80 by thread T12:
    #0 ipc_buffer_peek ipc_buffer.c:302 (ipc_channel_concurrent_test:arm64+0x10009aad4)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15934305, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T12 (tid=15934309, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:167 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f80 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:167 (ipc_channel_concurrent_test:arm64+0x10009a13c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006ee90)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006edd0)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006ed34)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006ece0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x10006cfa0)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f80 by thread T10:
    #0 ipc_buffer_peek ipc_buffer.c:302 (ipc_channel_concurrent_test:arm64+0x10009aad4)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T9 (tid=15934306, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15934307, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:167 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f88 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:168 (ipc_channel_concurrent_test:arm64+0x10009a148)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006ee90)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006edd0)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006ed34)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006ece0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x10006cfa0)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f88 by thread T10:
    #0 ipc_buffer_peek ipc_buffer.c:302 (ipc_channel_concurrent_test:arm64+0x10009aae0)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T9 (tid=15934306, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15934307, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:168 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=37072)
  Write of size 8 at 0x000109103f80 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:167 (ipc_channel_concurrent_test:arm64+0x10009a13c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b5a4)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x100068550)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x100068490)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x1000683f4)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000683a0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100066660)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000109103f80 by thread T11:
    #0 ipc_buffer_peek ipc_buffer.c:302 (ipc_channel_concurrent_test:arm64+0x10009aad4)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009b8d4)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b744)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000109103e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:76 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T7 (tid=15934304, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15934308, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:102 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:167 in ipc_buffer_write
==================
[doctest] doctest version is "2.4.12"
[doctest] run with "--help" for options
===============================================================================
[doctest] test cases:      5 |      5 passed | 0 failed | 0 skipped
[doctest] assertions: 907014 | 907014 passed | 0 failed |
[doctest] Status: SUCCESS!
ThreadSanitizer: reported 12 warnings

    Start 6: ipc_channel_interprocess_test
6/9 Test #6: ipc_channel_interprocess_test ..........   Passed    1.84 sec
    Start 7: ipc_buffer_stress_test
