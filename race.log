=== Building with ThreadSanitizer ===
-- The C compiler identification is AppleClang 17.0.0.17000013
-- The CXX compiler identification is AppleClang 17.0.0.17000013
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Check for working C compiler: /usr/bin/cc - skipped
-- Detecting C compile features
-- Detecting C compile features - done
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Check for working CXX compiler: /usr/bin/c++ - skipped
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Enabling ThreadSanitizer for shmipc_static
-- Enabling ThreadSanitizer for shmipc_shared
-- Performing Test CMAKE_HAVE_LIBC_PTHREAD
-- Performing Test CMAKE_HAVE_LIBC_PTHREAD - Success
-- Found Threads: TRUE
-- Enabling ThreadSanitizer for ipc_buffer_basic_test
-- Enabling ThreadSanitizer for ipc_channel_basic_test
-- Enabling ThreadSanitizer for ipc_mmap_test
-- Enabling ThreadSanitizer for ipc_buffer_concurrency_test
-- Enabling ThreadSanitizer for ipc_channel_concurrent_test
-- Enabling ThreadSanitizer for ipc_channel_interprocess_test
-- Enabling ThreadSanitizer for ipc_buffer_stress_test
-- Enabling ThreadSanitizer for ipc_channel_interprocess_stress_test
-- Enabling ThreadSanitizer for ipc_channel_stress_test
-- Configuring done (5.0s)
-- Generating done (0.1s)
-- Build files have been written to: /Users/stepan/libshmipc/build_tsan
[  3%] Building C object src/CMakeFiles/shmipc_static.dir/ipc_mmap.c.o
[  7%] Building C object src/CMakeFiles/shmipc_shared.dir/ipc_buffer.c.o
[ 10%] Building C object src/CMakeFiles/shmipc_static.dir/ipc_buffer.c.o
[ 14%] Building C object src/CMakeFiles/shmipc_shared.dir/ipc_channel.c.o
[ 17%] Building C object src/CMakeFiles/shmipc_static.dir/ipc_utils.c.o
[ 21%] Building C object src/CMakeFiles/shmipc_shared.dir/ipc_mmap.c.o
[ 25%] Building C object src/CMakeFiles/shmipc_static.dir/ipc_channel.c.o
[ 28%] Building C object src/CMakeFiles/shmipc_shared.dir/ipc_utils.c.o
[ 32%] Linking C shared library libshmipc_shared.dylib
[ 35%] Linking C static library libshmipc_static.a
[ 35%] Built target shmipc_static
[ 35%] Built target shmipc_shared
[ 39%] Building CXX object tests/CMakeFiles/ipc_channel_interprocess_test.dir/ipc_channel_interprocess_test.cpp.o
[ 42%] Building CXX object tests/CMakeFiles/ipc_buffer_concurrency_test.dir/ipc_buffer_concurrency_test.cpp.o
[ 46%] Building CXX object tests/CMakeFiles/ipc_mmap_test.dir/ipc_mmap_test.cpp.o
[ 50%] Building CXX object tests/CMakeFiles/ipc_buffer_basic_test.dir/ipc_buffer_basic_test.cpp.o
[ 57%] Building CXX object tests/CMakeFiles/ipc_buffer_stress_test.dir/ipc_buffer_stress_test.cpp.o
[ 60%] Building CXX object tests/CMakeFiles/ipc_channel_interprocess_stress_test.dir/ipc_channel_interprocess_stress_test.cpp.o
[ 57%] Building CXX object tests/CMakeFiles/ipc_channel_concurrent_test.dir/ipc_channel_concurrency_test.cpp.o
[ 64%] Building CXX object tests/CMakeFiles/ipc_channel_basic_test.dir/ipc_channel_basic_test.cpp.o
[ 67%] Building CXX object tests/CMakeFiles/ipc_channel_stress_test.dir/ipc_channel_stress_test.cpp.o
[ 71%] Linking CXX executable ipc_mmap_test
[ 75%] Linking CXX executable ipc_channel_interprocess_test
[ 78%] Linking CXX executable ipc_channel_basic_test
[ 82%] Linking CXX executable ipc_channel_interprocess_stress_test
[ 85%] Linking CXX executable ipc_channel_stress_test
[ 89%] Linking CXX executable ipc_buffer_basic_test
[ 92%] Linking CXX executable ipc_buffer_stress_test
[ 92%] Built target ipc_mmap_test
[ 92%] Built target ipc_channel_basic_test
[ 92%] Built target ipc_channel_interprocess_test
[ 92%] Built target ipc_channel_interprocess_stress_test
[ 92%] Built target ipc_channel_stress_test
[ 92%] Built target ipc_buffer_basic_test
[ 92%] Built target ipc_buffer_stress_test
[ 96%] Linking CXX executable ipc_channel_concurrent_test
[ 96%] Built target ipc_channel_concurrent_test
[100%] Linking CXX executable ipc_buffer_concurrency_test
[100%] Built target ipc_buffer_concurrency_test

=== Running tests with ThreadSanitizer ===
Test project /Users/stepan/libshmipc/build_tsan
    Start 1: ipc_buffer_basic_test
1/9 Test #1: ipc_buffer_basic_test ..................   Passed    0.51 sec
    Start 2: ipc_channel_basic_test
2/9 Test #2: ipc_channel_basic_test .................   Passed    0.72 sec
    Start 3: ipc_mmap_test
3/9 Test #3: ipc_mmap_test ..........................   Passed    0.63 sec
    Start 4: ipc_buffer_concurrency_test
4/9 Test #4: ipc_buffer_concurrency_test ............Subprocess aborted***Exception:  25.54 sec
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903ec8 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:169 (ipc_buffer_concurrency_test:arm64+0x1000c575c)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10006decc)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10006de0c)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10006dd70)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10006dd1c)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10006bfdc)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903ec8 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c591c)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T7 (tid=15721000, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T10 (tid=15721003, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:169 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903ec0 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:170 (ipc_buffer_concurrency_test:arm64+0x1000c5768)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10006decc)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10006de0c)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10006dd70)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10006dd1c)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10006bfdc)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903ec0 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c5910)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T7 (tid=15721000, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T10 (tid=15721003, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:170 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903ee8 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:169 (ipc_buffer_concurrency_test:arm64+0x1000c575c)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10007136c)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x1000712ac)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x100071210)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x1000711bc)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10006f47c)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903ee8 by thread T11:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c591c)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T8 (tid=15721001, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T11 (tid=15721004, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:169 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903ee0 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:170 (ipc_buffer_concurrency_test:arm64+0x1000c5768)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10007136c)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x1000712ac)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x100071210)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x1000711bc)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10006f47c)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903ee0 by thread T11:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c5910)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T8 (tid=15721001, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T11 (tid=15721004, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:170 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903f80 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:164 (ipc_buffer_concurrency_test:arm64+0x1000c5538)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10007136c)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x1000712ac)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x100071210)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x1000711bc)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10006f47c)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903f80 by thread T12:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c5910)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T8 (tid=15721001, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T12 (tid=15721005, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:164 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903f88 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:165 (ipc_buffer_concurrency_test:arm64+0x1000c5544)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10007136c)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x1000712ac)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x100071210)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x1000711bc)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10006f47c)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903f88 by thread T12:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c591c)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T8 (tid=15721001, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T12 (tid=15721005, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:165 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903f08 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:169 (ipc_buffer_concurrency_test:arm64+0x1000c575c)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10007480c)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10007474c)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x1000746b0)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10007465c)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10007291c)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903f08 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c591c)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T9 (tid=15721002, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T10 (tid=15721003, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:169 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903f00 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:170 (ipc_buffer_concurrency_test:arm64+0x1000c5768)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10007480c)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10007474c)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x1000746b0)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10007465c)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10007291c)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903f00 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c5910)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T9 (tid=15721002, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T10 (tid=15721003, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:170 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903f80 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:164 (ipc_buffer_concurrency_test:arm64+0x1000c5538)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10006decc)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10006de0c)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10006dd70)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10006dd1c)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10006bfdc)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903f80 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c5910)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T7 (tid=15721000, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T10 (tid=15721003, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:164 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903f88 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:165 (ipc_buffer_concurrency_test:arm64+0x1000c5544)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10006decc)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10006de0c)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10006dd70)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10006dd1c)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, int, unsigned long>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10006bfdc)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903f88 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c591c)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T7 (tid=15721000, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T10 (tid=15721003, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:165 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x000108903f80 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:164 (ipc_buffer_concurrency_test:arm64+0x1000c5538)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10007480c)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10007474c)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x1000746b0)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10007465c)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10007291c)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x000108903f80 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c5910)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 280 at 0x000108903e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:48 (ipc_buffer_concurrency_test:arm64+0x100023960)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T9 (tid=15721002, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T10 (tid=15721003, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_18() ipc_buffer_concurrency_test.cpp:60 (ipc_buffer_concurrency_test:arm64+0x100023c34)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:164 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18889)
  Write of size 8 at 0x00010c103b08 by thread T15:
    #0 ipc_buffer_write ipc_buffer.c:165 (ipc_buffer_concurrency_test:arm64+0x1000c5544)
    #1 concurrent_test_utils::produce_buffer(IpcBuffer*, unsigned long, unsigned long) concurrent_test_utils.h:16 (ipc_buffer_concurrency_test:arm64+0x10005128c)
    #2 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_buffer_concurrency_test:arm64+0x10007480c)
    #3 decltype(std::declval<void (&)(IpcBuffer*, unsigned long, unsigned long)>()(std::declval<IpcBuffer*>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10007474c)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x1000746b0)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10007465c)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*, unsigned long, unsigned long const&>(void (&)(IpcBuffer*, unsigned long, unsigned long), IpcBuffer*&&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10007291c)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Previous read of size 8 at 0x00010c103b08 by thread T18:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_buffer_concurrency_test:arm64+0x1000c591c)
    #1 concurrent_test_utils::consume_buffer(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:44 (ipc_buffer_concurrency_test:arm64+0x1000514b0)
    #2 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_buffer_concurrency_test:arm64+0x10005d518)
    #3 decltype(std::declval<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcBuffer*>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x10005d474)
    #4 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_buffer_concurrency_test:arm64+0x10005d3d8)
    #5 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_buffer_concurrency_test:arm64+0x10005d384)
    #6 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcBuffer*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcBuffer*&&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_buffer_concurrency_test:arm64+0x10005b644)
    #7 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_buffer_concurrency_test:arm64+0x1000627c4)
    #8 std::__1::function<void ()>::operator()() const function.h:989 (ipc_buffer_concurrency_test:arm64+0x100062720)
    #9 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_buffer_concurrency_test:arm64+0x100062680)
    #10 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_buffer_concurrency_test:arm64+0x1000625ac)
    #11 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_buffer_concurrency_test:arm64+0x1000615c8)

  Location is heap block of size 1048 at 0x00010c103700 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_buffer_concurrency_test:arm64+0x10002d1f8)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_buffer_concurrency_test:arm64+0x10002d11c)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_buffer_concurrency_test:arm64+0x100052e2c)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_buffer_concurrency_test:arm64+0x100052bcc)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_buffer_concurrency_test:arm64+0x100052598)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_buffer_concurrency_test:arm64+0x100052344)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_buffer_concurrency_test:arm64+0x1000521b8)
    #8 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051e48)
    #9 test_utils::BufferWrapper::BufferWrapper(unsigned long) test_utils.h:31 (ipc_buffer_concurrency_test:arm64+0x100051048)
    #10 DOCTEST_ANON_FUNC_20() ipc_buffer_concurrency_test.cpp:83 (ipc_buffer_concurrency_test:arm64+0x100024198)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T15 (tid=15721155, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_buffer_concurrency_test:arm64+0x1000516bc)
    #10 DOCTEST_ANON_FUNC_20() ipc_buffer_concurrency_test.cpp:101 (ipc_buffer_concurrency_test:arm64+0x100024480)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

  Thread T18 (tid=15721159, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_buffer_concurrency_test:arm64+0x100061530)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_buffer_concurrency_test:arm64+0x1000612ac)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_buffer_concurrency_test:arm64+0x1000611d0)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_buffer_concurrency_test:arm64+0x100061164)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_buffer_concurrency_test:arm64+0x1000610f4)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_buffer_concurrency_test:arm64+0x100060efc)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_buffer_concurrency_test:arm64+0x100060d4c)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_buffer_concurrency_test:arm64+0x100060440)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_buffer_concurrency_test:arm64+0x100051744)
    #10 DOCTEST_ANON_FUNC_20() ipc_buffer_concurrency_test.cpp:101 (ipc_buffer_concurrency_test:arm64+0x100024480)
    #11 doctest::Context::run() doctest.h:7035 (ipc_buffer_concurrency_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_buffer_concurrency_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:165 in ipc_buffer_write
==================
[doctest] doctest version is "2.4.12"
[doctest] run with "--help" for options
===============================================================================
[doctest] test cases:     16 |     16 passed | 0 failed | 0 skipped
[doctest] assertions: 614789 | 614789 passed | 0 failed |
[doctest] Status: SUCCESS!
ThreadSanitizer: reported 12 warnings

    Start 5: ipc_channel_concurrent_test
5/9 Test #5: ipc_channel_concurrent_test ............Subprocess aborted***Exception:  25.59 sec
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f20 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:170 (ipc_channel_concurrent_test:arm64+0x10009a368)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006ee90)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006edd0)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006ed34)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006ece0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x10006cfa0)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f20 by thread T10:
    #0 ipc_buffer_peek ipc_buffer.c:287 (ipc_channel_concurrent_test:arm64+0x10009a8c4)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009bb6c)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T9 (tid=15724223, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15724228, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:170 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f80 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:164 (ipc_channel_concurrent_test:arm64+0x10009a138)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f80 by thread T10:
    #0 ipc_buffer_peek ipc_buffer.c:287 (ipc_channel_concurrent_test:arm64+0x10009a8c4)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009bb6c)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15724220, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15724228, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:164 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f88 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:165 (ipc_channel_concurrent_test:arm64+0x10009a144)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f88 by thread T10:
    #0 ipc_buffer_peek ipc_buffer.c:293 (ipc_channel_concurrent_test:arm64+0x10009a990)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009bb6c)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15724220, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15724228, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:165 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f60 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:170 (ipc_channel_concurrent_test:arm64+0x10009a368)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f60 by thread T12:
    #0 ipc_buffer_peek ipc_buffer.c:287 (ipc_channel_concurrent_test:arm64+0x10009a8c4)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009bb6c)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15724220, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T12 (tid=15724231, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:170 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f68 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:169 (ipc_channel_concurrent_test:arm64+0x10009a35c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f68 by thread T12:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_channel_concurrent_test:arm64+0x10009a51c)
    #1 _try_read ipc_channel.c:471 (ipc_channel_concurrent_test:arm64+0x10009bc10)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15724220, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T12 (tid=15724231, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:169 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03ec8 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:169 (ipc_channel_concurrent_test:arm64+0x10009a35c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006ee90)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006edd0)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006ed34)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006ece0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x10006cfa0)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03ec8 by thread T12:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_channel_concurrent_test:arm64+0x10009a51c)
    #1 _try_read ipc_channel.c:471 (ipc_channel_concurrent_test:arm64+0x10009bc10)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T9 (tid=15724223, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T12 (tid=15724231, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:169 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03ec0 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:170 (ipc_channel_concurrent_test:arm64+0x10009a368)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006ee90)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006edd0)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006ed34)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006ece0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x10006cfa0)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03ec0 by thread T12:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_channel_concurrent_test:arm64+0x10009a510)
    #1 _try_read ipc_channel.c:471 (ipc_channel_concurrent_test:arm64+0x10009bc10)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T9 (tid=15724223, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T12 (tid=15724231, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:170 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f08 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:169 (ipc_channel_concurrent_test:arm64+0x10009a35c)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x100068550)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x100068490)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x1000683f4)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000683a0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100066660)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f08 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_channel_concurrent_test:arm64+0x10009a51c)
    #1 _try_read ipc_channel.c:471 (ipc_channel_concurrent_test:arm64+0x10009bc10)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T7 (tid=15724219, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15724228, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:169 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f00 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:170 (ipc_channel_concurrent_test:arm64+0x10009a368)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x100068550)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x100068490)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x1000683f4)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000683a0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100066660)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f00 by thread T10:
    #0 ipc_buffer_peek ipc_buffer.c:287 (ipc_channel_concurrent_test:arm64+0x10009a8c4)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009bb6c)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T7 (tid=15724219, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15724228, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:170 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f00 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:170 (ipc_channel_concurrent_test:arm64+0x10009a368)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f00 by thread T12:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_channel_concurrent_test:arm64+0x10009a510)
    #1 _try_read ipc_channel.c:471 (ipc_channel_concurrent_test:arm64+0x10009bc10)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15724220, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T12 (tid=15724231, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:170 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f80 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:164 (ipc_channel_concurrent_test:arm64+0x10009a138)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006ee90)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006edd0)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006ed34)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006ece0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x10006cfa0)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f80 by thread T11:
    #0 ipc_buffer_peek ipc_buffer.c:287 (ipc_channel_concurrent_test:arm64+0x10009a8c4)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009bb6c)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T9 (tid=15724223, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15724229, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:164 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f80 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:164 (ipc_channel_concurrent_test:arm64+0x10009a138)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x100068550)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x100068490)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x1000683f4)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000683a0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100066660)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f80 by thread T12:
    #0 ipc_buffer_peek ipc_buffer.c:287 (ipc_channel_concurrent_test:arm64+0x10009a8c4)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009bb6c)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T7 (tid=15724219, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T12 (tid=15724231, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:164 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f88 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:165 (ipc_channel_concurrent_test:arm64+0x10009a144)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x100068550)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x100068490)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x1000683f4)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000683a0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100066660)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f88 by thread T12:
    #0 ipc_buffer_peek ipc_buffer.c:293 (ipc_channel_concurrent_test:arm64+0x10009a990)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009bb6c)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T7 (tid=15724219, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T12 (tid=15724231, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:165 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f88 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:165 (ipc_channel_concurrent_test:arm64+0x10009a144)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006ee90)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006edd0)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006ed34)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006ece0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x10006cfa0)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f88 by thread T12:
    #0 ipc_buffer_peek ipc_buffer.c:293 (ipc_channel_concurrent_test:arm64+0x10009a990)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009bb6c)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T9 (tid=15724223, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T12 (tid=15724231, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:165 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03ec0 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:170 (ipc_channel_concurrent_test:arm64+0x10009a368)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x100068550)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x100068490)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x1000683f4)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000683a0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100066660)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03ec0 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_channel_concurrent_test:arm64+0x10009a510)
    #1 _try_read ipc_channel.c:471 (ipc_channel_concurrent_test:arm64+0x10009bc10)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T7 (tid=15724219, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15724228, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:170 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f88 by thread T7:
    #0 ipc_buffer_write ipc_buffer.c:165 (ipc_channel_concurrent_test:arm64+0x10009a144)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x100068550)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<int>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x100068490)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x1000683f4)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000683a0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, int&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100066660)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f88 by thread T11:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_channel_concurrent_test:arm64+0x10009a51c)
    #1 _try_read ipc_channel.c:471 (ipc_channel_concurrent_test:arm64+0x10009bc10)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T7 (tid=15724219, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15724229, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:165 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f80 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:164 (ipc_channel_concurrent_test:arm64+0x10009a138)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f80 by thread T11:
    #0 ipc_buffer_peek ipc_buffer.c:293 (ipc_channel_concurrent_test:arm64+0x10009a9a4)
    #1 _try_read ipc_channel.c:438 (ipc_channel_concurrent_test:arm64+0x10009bb6c)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15724220, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T11 (tid=15724229, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:164 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f80 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:164 (ipc_channel_concurrent_test:arm64+0x10009a138)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f80 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_channel_concurrent_test:arm64+0x10009a510)
    #1 _try_read ipc_channel.c:471 (ipc_channel_concurrent_test:arm64+0x10009bc10)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15724220, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15724228, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:164 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f88 by thread T8:
    #0 ipc_buffer_write ipc_buffer.c:165 (ipc_channel_concurrent_test:arm64+0x10009a144)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006b9f0)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006b930)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006b894)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006b840)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100069b00)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f88 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_channel_concurrent_test:arm64+0x10009a51c)
    #1 _try_read ipc_channel.c:471 (ipc_channel_concurrent_test:arm64+0x10009bc10)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T8 (tid=15724220, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15724228, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:165 in ipc_buffer_write
==================
==================
WARNING: ThreadSanitizer: data race (pid=18929)
  Write of size 8 at 0x000106f03f88 by thread T9:
    #0 ipc_buffer_write ipc_buffer.c:165 (ipc_channel_concurrent_test:arm64+0x10009a144)
    #1 ipc_channel_write ipc_channel.c:148 (ipc_channel_concurrent_test:arm64+0x10009b83c)
    #2 concurrent_test_utils::produce_channel(IpcChannel*, unsigned long, unsigned long) concurrent_test_utils.h:27 (ipc_channel_concurrent_test:arm64+0x10004cb80)
    #3 void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()::operator()() const concurrency_manager.hpp:23 (ipc_channel_concurrent_test:arm64+0x10006ee90)
    #4 decltype(std::declval<void (&)(IpcChannel*, unsigned long, unsigned long)>()(std::declval<IpcChannel*&>(), std::declval<unsigned long>(), std::declval<unsigned long const&>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10006edd0)
    #5 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x10006ed34)
    #6 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x10006ece0)
    #7 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_producer<void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long, unsigned long const&>(void (&)(IpcChannel*, unsigned long, unsigned long), IpcChannel*&, unsigned long&&, unsigned long const&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x10006cfa0)
    #8 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #9 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #10 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #11 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #12 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Previous read of size 8 at 0x000106f03f88 by thread T10:
    #0 ipc_buffer_read ipc_buffer.c:211 (ipc_channel_concurrent_test:arm64+0x10009a51c)
    #1 _try_read ipc_channel.c:471 (ipc_channel_concurrent_test:arm64+0x10009bc10)
    #2 ipc_channel_try_read ipc_channel.c:185 (ipc_channel_concurrent_test:arm64+0x10009b9dc)
    #3 concurrent_test_utils::consume_channel(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&) concurrent_test_utils.h:62 (ipc_channel_concurrent_test:arm64+0x10004cd20)
    #4 void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()::operator()() const concurrency_manager.hpp:32 (ipc_channel_concurrent_test:arm64+0x100058848)
    #5 decltype(std::declval<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&)>()(std::declval<IpcChannel*&>(), std::declval<std::__1::reference_wrapper<UnsafeCollector<unsigned long>>>(), std::declval<std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>())) std::__1::__invoke[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x1000587a4)
    #6 void std::__1::__invoke_void_return_wrapper<void, true>::__call[abi:ne190102]<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&>(void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()&) invoke.h:224 (ipc_channel_concurrent_test:arm64+0x100058708)
    #7 std::__1::__function::__alloc_func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()[abi:ne190102]() function.h:171 (ipc_channel_concurrent_test:arm64+0x1000586b4)
    #8 std::__1::__function::__func<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'(), std::__1::allocator<void ConcurrencyManager<unsigned long>::add_consumer<void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>>(void (&)(IpcChannel*, UnsafeCollector<unsigned long>&, ConcurrencyManager<unsigned long>&), IpcChannel*&, std::__1::reference_wrapper<UnsafeCollector<unsigned long>>&&, std::__1::reference_wrapper<ConcurrencyManager<unsigned long>>&&)::'lambda'()>, void ()>::operator()() function.h:313 (ipc_channel_concurrent_test:arm64+0x100056974)
    #9 std::__1::__function::__value_func<void ()>::operator()[abi:ne190102]() const function.h:430 (ipc_channel_concurrent_test:arm64+0x10005ce38)
    #10 std::__1::function<void ()>::operator()() const function.h:989 (ipc_channel_concurrent_test:arm64+0x10005cd94)
    #11 decltype(std::declval<std::__1::function<void ()>>()()) std::__1::__invoke[abi:ne190102]<std::__1::function<void ()>>(std::__1::function<void ()>&&) invoke.h:149 (ipc_channel_concurrent_test:arm64+0x10005ccf4)
    #12 void std::__1::__thread_execute[abi:ne190102]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>&, std::__1::__tuple_indices<>) thread.h:198 (ipc_channel_concurrent_test:arm64+0x10005cc20)
    #13 void* std::__1::__thread_proxy[abi:ne190102]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, std::__1::function<void ()>>>(void*) thread.h:207 (ipc_channel_concurrent_test:arm64+0x10005bc3c)

  Location is heap block of size 280 at 0x000106f03e80 allocated by main thread:
    #0 operator new(unsigned long) <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x8a60c)
    #1 void* std::__1::__libcpp_operator_new[abi:ne190102]<unsigned long>(unsigned long) new:297 (ipc_channel_concurrent_test:arm64+0x100028a94)
    #2 std::__1::__libcpp_allocate[abi:ne190102](unsigned long, unsigned long) new:321 (ipc_channel_concurrent_test:arm64+0x1000289b8)
    #3 std::__1::allocator<unsigned char>::allocate[abi:ne190102](unsigned long) allocator.h:118 (ipc_channel_concurrent_test:arm64+0x10004e1b8)
    #4 std::__1::__allocation_result<std::__1::allocator_traits<std::__1::allocator<unsigned char>>::pointer> std::__1::__allocate_at_least[abi:ne190102]<std::__1::allocator<unsigned char>>(std::__1::allocator<unsigned char>&, unsigned long) allocate_at_least.h:41 (ipc_channel_concurrent_test:arm64+0x10004df58)
    #5 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::__vallocate[abi:ne190102](unsigned long) vector:781 (ipc_channel_concurrent_test:arm64+0x10004d924)
    #6 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:444 (ipc_channel_concurrent_test:arm64+0x10004d6d0)
    #7 std::__1::vector<unsigned char, std::__1::allocator<unsigned char>>::vector[abi:ne190102](unsigned long) vector:441 (ipc_channel_concurrent_test:arm64+0x10004c8e4)
    #8 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:75 (ipc_channel_concurrent_test:arm64+0x100023928)
    #9 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #10 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T9 (tid=15724223, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:48 (ipc_channel_concurrent_test:arm64+0x10004cef4)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

  Thread T10 (tid=15724228, running) created by main thread at:
    #0 pthread_create <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x32b00)
    #1 std::__1::__libcpp_thread_create[abi:ne190102](_opaque_pthread_t**, void* (*)(void*), void*) pthread.h:182 (ipc_channel_concurrent_test:arm64+0x10005bba4)
    #2 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:217 (ipc_channel_concurrent_test:arm64+0x10005b920)
    #3 std::__1::thread::thread<std::__1::function<void ()>&, 0>(std::__1::function<void ()>&) thread.h:212 (ipc_channel_concurrent_test:arm64+0x10005b844)
    #4 std::__1::thread* std::__1::construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:41 (ipc_channel_concurrent_test:arm64+0x10005b7d8)
    #5 std::__1::thread* std::__1::__construct_at[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, std::__1::thread*>(std::__1::thread*, std::__1::function<void ()>&) construct_at.h:49 (ipc_channel_concurrent_test:arm64+0x10005b768)
    #6 void std::__1::allocator_traits<std::__1::allocator<std::__1::thread>>::construct[abi:ne190102]<std::__1::thread, std::__1::function<void ()>&, void, 0>(std::__1::allocator<std::__1::thread>&, std::__1::thread*, std::__1::function<void ()>&) allocator_traits.h:328 (ipc_channel_concurrent_test:arm64+0x10005b570)
    #7 std::__1::thread* std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::__emplace_back_slow_path<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1538 (ipc_channel_concurrent_test:arm64+0x10005b3c0)
    #8 std::__1::thread& std::__1::vector<std::__1::thread, std::__1::allocator<std::__1::thread>>::emplace_back<std::__1::function<void ()>&>(std::__1::function<void ()>&) vector:1558 (ipc_channel_concurrent_test:arm64+0x10005aab4)
    #9 ConcurrencyManager<unsigned long>::run_and_wait() concurrency_manager.hpp:53 (ipc_channel_concurrent_test:arm64+0x10004cf7c)
    #10 DOCTEST_ANON_FUNC_18() ipc_channel_concurrency_test.cpp:101 (ipc_channel_concurrent_test:arm64+0x100023b80)
    #11 doctest::Context::run() doctest.h:7035 (ipc_channel_concurrent_test:arm64+0x1000154a8)
    #12 main doctest.h:7113 (ipc_channel_concurrent_test:arm64+0x100018b6c)

SUMMARY: ThreadSanitizer: data race ipc_buffer.c:165 in ipc_buffer_write
==================
[doctest] doctest version is "2.4.12"
[doctest] run with "--help" for options
===============================================================================
[doctest] test cases:      5 |      5 passed | 0 failed | 0 skipped
[doctest] assertions: 907014 | 907014 passed | 0 failed |
[doctest] Status: SUCCESS!
ThreadSanitizer: reported 20 warnings

    Start 6: ipc_channel_interprocess_test
6/9 Test #6: ipc_channel_interprocess_test ..........   Passed    1.77 sec
    Start 7: ipc_buffer_stress_test
7/9 Test #7: ipc_buffer_stress_test .................   Passed  109.01 sec
    Start 8: ipc_channel_interprocess_stress_test
8/9 Test #8: ipc_channel_interprocess_stress_test ...Subprocess aborted***Exception:   1.63 sec
[doctest] doctest version is "2.4.12"
[doctest] run with "--help" for options
Simple stress reader throughput: 232126 ops/sec
[doctest] doctest version is "2.4.12"
[doctest] run with "--help" for options
Simple stress writer throughput: 224749 ops/sec

=== Testing data size: 4 bytes ===
ThreadSanitizer:DEADLYSIGNAL
==18982==ERROR: ThreadSanitizer: BUS on unknown address (pc 0x0001010c4250 bp 0x00016f43cc80 sp 0x00016f43cc50 T15728205)
==18982==The signal is caused by a READ memory access.
==18982==Hint: this fault was caused by a dereference of a high value address (see register values below).  Disassemble the provided pc to learn which register was used.
Writer throughput: 206526 ops/sec, 0.79 MB/sec
    #0 __tsan_atomic64_load <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x5c250)
    #1 ipc_buffer_peek ipc_buffer.c:286 (ipc_channel_interprocess_stress_test:arm64+0x10007a86c)
    #2 _read ipc_channel.c:348 (ipc_channel_interprocess_stress_test:arm64+0x10007bfa0)
    #3 ipc_channel_read ipc_channel.c:204 (ipc_channel_interprocess_stress_test:arm64+0x10007bdd0)
    #4 DOCTEST_ANON_FUNC_16() ipc_channel_interprocess_stress_test.cpp:121 (ipc_channel_interprocess_stress_test:arm64+0x100024138)
    #5 doctest::Context::run() doctest.h:7035 (ipc_channel_interprocess_stress_test:arm64+0x1000154a8)
    #6 main doctest.h:7113 (ipc_channel_interprocess_stress_test:arm64+0x100018b6c)
    #7 start <null> (dyld:arm64e+0xfffffffffff3ab94)

==18982==Register values:
 x[0] = 0x0000000102559080   x[1] = 0x0000000000000005   x[2] = 0x00000000400203ff   x[3] = 0x000000016f43cd40  
 x[4] = 0x0000000101098354   x[5] = 0x0000000000000000   x[6] = 0x17000001fd084018   x[7] = 0x000000016f43da20  
 x[8] = 0x0000000102559f38   x[9] = 0x0000000000000004  x[10] = 0x0000000000000005  x[11] = 0x0000000000000005  
x[12] = 0x0000100209200704  x[13] = 0x0000000000000000  x[14] = 0x0000000000000000  x[15] = 0x0000000000000003  
x[16] = 0x000000018f36abf0  x[17] = 0x0000000101114b18  x[18] = 0x0000000000000000  x[19] = 0x000000010500303d  
x[20] = 0x0000000102559080  x[21] = 0x0000000100a3a870  x[22] = 0x0000000000000005  x[23] = 0x0000000000000000  
x[24] = 0x0000000000000005  x[25] = 0x000000016f43ea90  x[26] = 0x0000000000000000  x[27] = 0x0000000000000000  
x[28] = 0x0000000000000000     fp = 0x000000016f43cc80     lr = 0x00000001010c41ec     sp = 0x000000016f43cc50  
ThreadSanitizer can not provide additional info.
SUMMARY: ThreadSanitizer: BUS ipc_buffer.c:286 in ipc_buffer_peek
==18982==ABORTING
===============================================================================
/Users/stepan/libshmipc/tests/ipc_channel_interprocess_stress_test.cpp:95:
TEST CASE:  interprocess stress - variable data sizes

/Users/stepan/libshmipc/tests/ipc_channel_interprocess_stress_test.cpp:95: FATAL ERROR: test case CRASHED: SIGABRT - Abort (abnormal termination) signal

===============================================================================
[doctest] test cases:    2 |    1 passed | 1 failed | 2 skipped
[doctest] assertions: 5005 | 5005 passed | 0 failed |
[doctest] Status: FAILURE!

=== Testing data size: 8 bytes ===
===============================================================================
/Users/stepan/libshmipc/tests/ipc_channel_interprocess_stress_test.cpp:95:
TEST CASE:  interprocess stress - variable data sizes

/Users/stepan/libshmipc/tests/ipc_channel_interprocess_stress_test.cpp:95: FATAL ERROR: test case CRASHED: SIGSEGV - Segmentation violation signal

===============================================================================
[doctest] test cases:    2 |    1 passed | 1 failed | 2 skipped
[doctest] assertions: 5506 | 5506 passed | 0 failed |
[doctest] Status: FAILURE!
ThreadSanitizer:DEADLYSIGNAL
==18980==ERROR: ThreadSanitizer: SEGV on unknown address 0x000000000000 (pc 0x000100a39eb8 bp 0x00016f43cd40 sp 0x00016f43cd10 T15728186)
==18980==The signal is caused by a READ memory access.
==18980==Hint: address points to the zero page.
ThreadSanitizer:DEADLYSIGNAL
==18984==ERROR: ThreadSanitizer: BUS on unknown address (pc 0x0001010c4250 bp 0x00016f43cc80 sp 0x00016f43cc50 T15728236)
==18984==The signal is caused by a READ memory access.
==18984==Hint: this fault was caused by a dereference of a high value address (see register values below).  Disassemble the provided pc to learn which register was used.
    #0 __tsan_atomic64_load <null> (libclang_rt.tsan_osx_dynamic.dylib:arm64e+0x5c250)
    #1 ipc_buffer_peek ipc_buffer.c:286 (ipc_channel_interprocess_stress_test:arm64+0x10007a86c)
    #2 _read ipc_channel.c:348 (ipc_channel_interprocess_stress_test:arm64+0x10007bfa0)
    #3 ipc_channel_read ipc_channel.c:204 (ipc_channel_interprocess_stress_test:arm64+0x10007bdd0)
    #4 DOCTEST_ANON_FUNC_16() ipc_channel_interprocess_stress_test.cpp:121 (ipc_channel_interprocess_stress_test:arm64+0x100024138)
    #5 doctest::Context::run() doctest.h:7035 (ipc_channel_interprocess_stress_test:arm64+0x1000154a8)
    #6 main doctest.h:7113 (ipc_channel_interprocess_stress_test:arm64+0x100018b6c)
    #7 start <null> (dyld:arm64e+0xfffffffffff3ab94)

==18984==Register values:
 x[0] = 0x0000000102559080   x[1] = 0x0000000000000005   x[2] = 0x00000000400204ff   x[3] = 0x000000016f43cd40  
 x[4] = 0x0000000101098354   x[5] = 0x0000000000000000   x[6] = 0x17000001fd084018   x[7] = 0x000000016f43da20  
 x[8] = 0x0000000102559f38   x[9] = 0x0000000000000004  x[10] = 0x0000000000000005  x[11] = 0x0000000000000005  
x[12] = 0x00001002092006e4  x[13] = 0x0000000000000000  x[14] = 0x0000000000000000  x[15] = 0x0000000000000004  
x[16] = 0x000000018f36abf0  x[17] = 0x0000000101114b18  x[18] = 0x0000000000000000  x[19] = 0x000000000000303d  
x[20] = 0x0000000102559080  x[21] = 0x0000000100a3a870  x[22] = 0x0000000000000005  x[23] = 0x0000000000000000  
x[24] = 0x0000000000000005  x[25] = 0x000000016f43ea90  x[26] = 0x0000000000000000  x[27] = 0x0000000000000000  
x[28] = 0x0000000000000000     fp = 0x000000016f43cc80     lr = 0x00000001010c41ec     sp = 0x000000016f43cc50  
ThreadSanitizer can not provide additional info.
SUMMARY: ThreadSanitizer: BUS ipc_buffer.c:286 in ipc_buffer_peek
==18984==ABORTING
===============================================================================
/Users/stepan/libshmipc/tests/ipc_channel_interprocess_stress_test.cpp:95:
TEST CASE:  interprocess stress - variable data sizes

/Users/stepan/libshmipc/tests/ipc_channel_interprocess_stress_test.cpp:95: FATAL ERROR: test case CRASHED: SIGABRT - Abort (abnormal termination) signal

===============================================================================
[doctest] test cases:    2 |    1 passed | 1 failed | 2 skipped
[doctest] assertions: 5507 | 5507 passed | 0 failed |
[doctest] Status: FAILURE!
    #0 ipc_buffer_create ipc_buffer.c:70 (ipc_channel_interprocess_stress_test:arm64+0x100079eb8)
    #1 ipc_channel_create ipc_channel.c:54 (ipc_channel_interprocess_stress_test:arm64+0x10007b3a0)
    #2 DOCTEST_ANON_FUNC_16() ipc_channel_interprocess_stress_test.cpp:142 (ipc_channel_interprocess_stress_test:arm64+0x100024778)
    #3 doctest::Context::run() doctest.h:7035 (ipc_channel_interprocess_stress_test:arm64+0x1000154a8)
    #4 main doctest.h:7113 (ipc_channel_interprocess_stress_test:arm64+0x100018b6c)
    #5 start <null> (dyld:arm64e+0xfffffffffff3ab94)

==18980==Register values:
 x[0] = 0x0000000102559080   x[1] = 0x00001000000007f0   x[2] = 0x00000000000204ff   x[3] = 0x0000000000000010  
 x[4] = 0x0000000000000010   x[5] = 0x0000000000000000   x[6] = 0x00000000000186a0   x[7] = 0x0000000000000000  
 x[8] = 0x000000003f880599   x[9] = 0x00000001031dafe0  x[10] = 0x0000000000020400  x[11] = 0x0000000000000000  
x[12] = 0x00001000000007f0  x[13] = 0x0000000000000000  x[14] = 0x0000000000000000  x[15] = 0x0000000000000000  
x[16] = 0x000000018f36abf0  x[17] = 0x0000000101114b18  x[18] = 0x0000000000000000  x[19] = 0x000000016f43cd50  
x[20] = 0x0000000000100000  x[21] = 0x00000000000003e8  x[22] = 0x0000000104900380  x[23] = 0x0000000000000400  
x[24] = 0x0000000000000400  x[25] = 0x00000000000003e8  x[26] = 0x0000000000000000  x[27] = 0x0000000000000000  
x[28] = 0x0000000000000000     fp = 0x000000016f43cd40     lr = 0x0000000100a39eb8     sp = 0x000000016f43cd10  
ThreadSanitizer can not provide additional info.
SUMMARY: ThreadSanitizer: SEGV ipc_buffer.c:70 in ipc_buffer_create
==18980==ABORTING

    Start 9: ipc_channel_stress_test
9/9 Test #9: ipc_channel_stress_test ................   Passed    2.75 sec

67% tests passed, 3 tests failed out of 9

Total Test time (real) = 168.18 sec

The following tests FAILED:
	  4 - ipc_buffer_concurrency_test (Subprocess aborted)
	  5 - ipc_channel_concurrent_test (Subprocess aborted)
	  8 - ipc_channel_interprocess_stress_test (Subprocess aborted)
